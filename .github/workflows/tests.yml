name: Mobile Tests (BrowserStack)

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

jobs:
  wdio:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # âœ… Roda testes, mas NÃƒO quebra o job
      # âœ… Guarda o exit code num arquivo e mostra um resumo do erro no log
      - name: Run WDIO tests (do not fail pipeline)
        env:
          BROWSERSTACK_USER: ${{ secrets.BROWSERSTACK_USER }}
          BROWSERSTACK_KEY: ${{ secrets.BROWSERSTACK_KEY }}
        shell: bash
        run: |
          set +e
          npx wdio run wdio.conf.js 2>&1 | tee wdio.log
          echo $? > wdio_exit_code.txt

          echo ""
          echo "=============================="
          echo "ðŸ“Œ RESUMO DE FALHAS (se houver)"
          echo "=============================="
          grep -nE "failing|FAILED|Error:|still not displayed|Expect|AssertionError" wdio.log || true
          echo "=============================="
          echo ""

          # NÃ£o falhar o step:
          exit 0

      # âœ… Gera Allure SEMPRE (mesmo se falhou)
      - name: Generate Allure report
        if: always()
        run: npx allure-commandline generate allure-results --clean -o allure-report

      # âœ… Sobe evidÃªncias SEMPRE
      - name: Upload artifacts (Allure + logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            allure-results
            allure-report
            wdio.log
            wdio_exit_code.txt
